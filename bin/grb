#!/bin/zsh
BRANCH=$(git symbolic-ref HEAD --short)
PROJECT_ROOT=$(git rev-parse --show-toplevel)

if [ -z "$1" ]; then
  BASE="develop"
else
  BASE="$1"
fi

if [ -n "$(git status --porcelain)" ];
then
  UNCLEAN='You have uncommitted changes. I will stash them for you.'
fi

echo "Project root directory: ${PROJECT_ROOT}"
echo "Rebasing onto ${BASE}"

if [ -n "$UNCLEAN" ]
then
  git stash
  echo
  echo "$UNCLEAN"
fi

echo
echo "Switching branch to $BASE"
git checkout $BASE

echo
echo "Pulling remove changes"
git pull origin $BASE

echo
echo "Switching back to $BRANCH"
git checkout $BRANCH

echo
echo "Rebasing onto $BASE"
git rebase $BASE

if [ -n "$UNCLEAN" ]
then
  echo
  echo "Popping stash."
  git stash pop

fi

if [ -d "${PROJECT_ROOT}/node_modules" ]; then
  echo
  echo "Checking for new node modules."
  npm install
fi
